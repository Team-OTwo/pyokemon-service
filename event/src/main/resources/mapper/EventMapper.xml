<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pyokemon.event.repository.EventRepository">

    <resultMap id="EventResultMap" type="com.pyokemon.event.entity.Event">
        <id column="event_id" property="eventId"/>
        <result column="account_id" property="accountId"/>
        <result column="title" property="title"/>
        <result column="age_limit" property="ageLimit"/>
        <result column="description" property="description"/>
        <result column="genre" property="genre"/>
        <result column="thumbnail_url" property="thumbnailUrl"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <select id="findById" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE event_id = #{eventId}
    </select>

    <select id="findByTenantId" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE account_id = #{tenantId}
    </select>

    <select id="findByAccountId" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE account_id = #{accountId}
    </select>

    <select id="findTenantEventListByAccountId" resultType="com.pyokemon.event.dto.TenantEventListDto">
        SELECT 
            e.event_id as eventId,
            e.thumbnail_url as thumbnailUrl,
            e.title,
            es.event_date as eventDate,
            v.venue_name as venueName,
            e.status
        FROM tb_event e
        LEFT JOIN tb_event_schedule es ON e.event_id = es.event_id
        LEFT JOIN tb_venue v ON es.venue_id = v.venue_id
        WHERE e.account_id = #{accountId}
        ORDER BY es.event_date ASC
    </select>

    <select id="findByStatus" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE status = #{status}
    </select>

    <select id="findByGenre" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE genre = #{genre}
    </select>

    <select id="findByTitleContainingIgnoreCase" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE LOWER(title) LIKE LOWER(CONCAT('%', #{title}, '%'))
    </select>

    <select id="findByAgeLimit" resultMap="EventResultMap">
        SELECT * FROM tb_event WHERE age_limit = #{ageLimit}
    </select>

    <insert id="save" parameterType="com.pyokemon.event.entity.Event" useGeneratedKeys="true" keyProperty="eventId">
        INSERT INTO tb_event (
            account_id, title, age_limit, description, genre, 
            thumbnail_url, status, created_at, updated_at
        ) VALUES (
            #{accountId}, #{title}, #{ageLimit}, #{description}, #{genre}, 
            #{thumbnailUrl}, #{status}, #{createdAt}, #{updatedAt}
        )
        <selectKey resultType="long" keyProperty="eventId" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="updateEvent" parameterType="com.pyokemon.event.entity.Event">
        UPDATE tb_event SET
            title = #{title},
            age_limit = #{ageLimit},
            description = #{description},
            genre = #{genre},
            thumbnail_url = #{thumbnailUrl},
            status = #{status},
            updated_at = #{updatedAt}
        WHERE event_id = #{eventId}
    </update>

    <select id="findEventDetailByEventId" resultType="com.pyokemon.event.dto.EventDetailResponseDTO">
        SELECT 
            e.event_id as eventId,
            e.account_id as accountId,
            e.title,
            e.age_limit as ageLimit,
            e.description,
            e.genre,
            e.thumbnail_url as thumbnailUrl,
            e.status,
            e.created_at as createdAt,
            e.updated_at as updatedAt
        FROM tb_event e
        WHERE e.event_id = #{eventId}
    </select>

</mapper>
